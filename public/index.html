<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Spotify Authorization Code Flow Example</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Login Section -->
    <div id="login">
      <h1>This is an example of the Authorization Code flow</h1>
      <button id="loginBtn" class="btn btn-primary">Log in with Spotify</button>
    </div>

    <!-- Logged In Section -->
    <div id="loggedin">
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <button id="obtain-new-token" class="btn btn-default">Obtain new token using the refresh token</button>
    </div>
  </div>

  <!-- Handlebars Templates -->
  <script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
      <div class="pull-left">
        <img class="media-object" width="150" src="{{images.0.url}}" />
      </div>
      <div class="media-body">
        <dl class="dl-horizontal">
          <dt>Display name</dt>
          <dd class="clearfix">{{display_name}}</dd>
          <dt>Id</dt>
          <dd>{{id}}</dd>
          <dt>Email</dt>
          <dd>{{email}}</dd>
          <dt>Spotify URI</dt>
          <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
          <dt>Link</dt>
          <dd><a href="{{href}}">{{href}}</a></dd>
          <dt>Profile Image</dt>
          <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
          <dt>Country</dt>
          <dd>{{country}}</dd>
        </dl>
      </div>
    </div>
  </script>

  <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
      <dt>Access token</dt>
      <dd class="text-overflow">{{access_token}}</dd>
      <dt>Refresh token</dt>
      <dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
  </script>

  <!-- JavaScript -->
  <script>
    // Immediately Invoked Function Expression (IIFE)
    (function () {
      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      // Get hash parameters from the URL
      var params = getHashParams();
      var access_token = params.access_token;
      var refresh_token = params.refresh_token;
      var error = params.error;

      if (error) {
        alert('There was an error during the authentication');
      } else {
        // If access token is present, user is logged in
        if (access_token) {
          // Show the OAuth info
          document.getElementById('oauth').innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
          });

          // Make an AJAX request to get user profile information
          // (Note: This would typically be done on the server-side in a production environment)
          fetch('https://api.spotify.com/v1/me', {
            headers: {
              'Authorization': 'Bearer ' + access_token
            }
          })
            .then(response => response.json())
            .then(function (response) {
              // Show the user profile
              document.getElementById('user-profile').innerHTML = userProfileTemplate(response);

              // Hide login and show logged-in section
              document.getElementById('login').style.display = 'none';
              document.getElementById('loggedin').style.display = 'block';
            })
            .catch(function (error) {
              console.error('Error fetching user profile:', error);
            });
        } else {
          // If no access token, show the login section
          document.getElementById('login').style.display = 'block';
          document.getElementById('loggedin').style.display = 'none';
        }

        // Add event listener for the "Obtain new token" button
        document.getElementById('obtain-new-token').addEventListener('click', function () {
          // Make an AJAX request to refresh the access token
          // (Note: This would typically be done on the server-side in a production environment)
          fetch('/refresh_token?refresh_token=' + refresh_token)
            .then(response => response.json())
            .then(function (data) {
              // Update the access token
              access_token = data.access_token;

              // Update the OAuth info section
              document.getElementById('oauth').innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            })
            .catch(function (error) {
              console.error('Error refreshing token:', error);
            });
        });
      }
    })();
  </script>
</body>

</html>
